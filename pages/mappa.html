<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mappa Interattiva – DnD</title>
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }
    /* Popup compatto e leggibile */
    .leaflet-popup-content { font: 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .legend {
      position: absolute; z-index: 1000; right: 10px; top: 10px;
      background: rgba(255,255,255,.9); padding: .6rem .8rem; border-radius: .75rem;
      box-shadow: 0 6px 18px rgba(0,0,0,.12); font: 13px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    .legend h3 { margin: 0 0 .25rem; font-size: 14px; }
    .legend p { margin: 0; opacity: .8; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="legend">
    <h3>Mappa della Campagna</h3>
    <p>Zoom con mouse / pinch • Trascina per muovere • Clic per copiare coordinate</p>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin="">
  </script>

  <script>
    // === 1) CONFIGURA IL TUO FILE IMMAGINE DELLA MAPPA ===
    // Sostituisci con il percorso della tua mappa (PNG/JPG/SVG rasterizzato)
    const MAP_IMAGE_URL = 'sarogal.png'; // <-- metti qui il tuo file

    // Imposta zoom min/max a piacere (valori negativi = zoom out oltre scala 1:1)
    const MIN_ZOOM = -2;
    const MAX_ZOOM = 2;

    // === 2) DATI DI ESEMPIO: Punti d'interesse (POI) e Regioni ===
    // Coordinate in CRS.Simple: [lat(y), lng(x)] con origine (0,0) in ALTO-SINISTRA dell'immagine

    const POIS = [
      {
        name: 'Vingaldrum',
        at: [820, 1260],
        html: '<b>Vingaldrum</b><br/>Città degli elfi alti. Dea: Thalindra.'
      },
      {
        name: 'Altare di Lolth',
        at: [1520, 920],
        html: '<b>Altare di Lolth</b><br/>Sito rituale della Legione delle Mille Fenditure.'
      },
    ];

    const REGIONS = [
      {
        name: 'Pianure di Smeraldo',
        // poligono: elenco di vertici [y, x]
        shape: [ [400,400], [480,980], [860,900], [900,500], [700,350] ],
        style: { color: '#2e7d32', weight: 2, fillOpacity: 0.15 }
      },
      {
        name: 'Catena del Drago',
        shape: [ [1200,300], [1100,700], [1350,760], [1500,520] ],
        style: { color: '#5d4037', weight: 2, dashArray: '6 4', fillOpacity: 0.12 }
      }
    ];

    // === 3) CARICA L'IMMAGINE E CREA LA MAPPA ===
    const img = new Image();
    img.src = MAP_IMAGE_URL;
    img.onload = () => {
      const w = img.naturalWidth;
      const h = img.naturalHeight;
      if (!w || !h) {
        alert('Impossibile leggere dimensioni della mappa. Verifica il percorso del file.');
        return;
      }

      // In CRS.Simple: bounds = angolo alto-sinistra [0,0] e basso-destra [h,w]
      const bounds = [[0, 0], [h, w]];

      const map = L.map('map', {
        crs: L.CRS.Simple,
        minZoom: MIN_ZOOM,
        maxZoom: MAX_ZOOM,
        maxBounds: bounds,
        maxBoundsViscosity: 1.0,
        attributionControl: false,
        zoomControl: true
      });

      // Sovrapponi l'immagine di sfondo
      const image = L.imageOverlay(MAP_IMAGE_URL, bounds).addTo(map);
      map.fitBounds(bounds);

      // Scala metrica (puramente estetica in CRS.Simple)
      L.control.scale({ metric: true, imperial: false }).addTo(map);

      // Layer per organizzare contenuti
      const poiLayer = L.layerGroup().addTo(map);
      const regionLayer = L.layerGroup().addTo(map);

      // Icona base (SVG inline) per marker
      const icon = L.icon({
        iconUrl: 'data:image/svg+xml;utf8,' + encodeURIComponent(`
          <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24">
            <path d="M12 2C8.14 2 5 5.14 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.86-3.14-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5S13.38 11.5 12 11.5z"/>
          </svg>
        `),
        iconSize: [28, 28],
        iconAnchor: [14, 28],
        popupAnchor: [0, -28]
      });

      // Aggiungi POI
      POIS.forEach(p => {
        L.marker(p.at, { icon }).addTo(poiLayer).bindPopup(p.html || p.name);
      });

      // Aggiungi Regioni
      REGIONS.forEach(r => {
        L.polygon(r.shape, r.style || {}).addTo(regionLayer).bindTooltip(r.name, { sticky: true });
      });

      // Controllo layer
      L.control.layers(null, {
        'Punti d\'interesse': poiLayer,
        'Regioni': regionLayer
      }, { collapsed: false }).addTo(map);

      // Click per ottenere coordinate (copiate negli appunti se possibile)
      map.on('click', (e) => {
        const y = e.latlng.lat; // in CRS.Simple, lat = Y (verso il basso)
        const x = e.latlng.lng; // lng = X (verso destra)
        const text = `[${y.toFixed(1)}, ${x.toFixed(1)}]`;
        L.popup().setLatLng(e.latlng).setContent(`Coordinate: <b>${text}</b><br/><small>(CRS.Simple)</small>`).openOn(map);
        if (navigator.clipboard) navigator.clipboard.writeText(text).catch(() => {});
        console.log('Coordinate cliccate:', text);
      });

      // Limita il pan fuori mappa
      map.setMaxBounds(bounds);
    };

    img.onerror = () => {
      alert('Non riesco a caricare la mappa: controlla MAP_IMAGE_URL (attuale: ' + MAP_IMAGE_URL + ')');
    };
  </script>
</body>
</html>

