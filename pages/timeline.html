<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Timeline - Campagna (DR)</title>
<link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Cardo&display=swap" rel="stylesheet">
<style>
  :root{
    --bg-paper: #f6f1e1;
    --ink:#3b2f1c;
    --accent-gold:#d4af37;
    --header-bg:#5c3b1e;
    --muted:#6b6b6b;
    --accent-cool:#7dd3fc;
  }
  html,body{height:100%;}
  body {
    margin: 0;
    font-family: 'Cardo', serif;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    background: var(--bg-paper) url('parchment-bg.jpg') repeat;
    color: var(--ink);
    -webkit-font-smoothing:antialiased;
  }

  header {
    background: var(--header-bg);
    color: white;
    padding: .6rem 1rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    font-family: 'MedievalSharp', cursive;
    border-bottom: 4px solid var(--accent-gold);
  }
  header a{ color:#f3e5ab; text-decoration:none; font-weight:bold }
  header a:hover{ text-decoration:underline; color:#ffd700 }

  /* Page layout */
  .wrap{width:100%; max-width:1100px; margin:28px auto; padding:0 18px}
  .panel{background:rgba(255,255,255,0.96); border:3px solid var(--accent-gold); border-radius:12px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,0.12)}
  h1.title{font-family:'MedievalSharp',cursive; color:var(--header-bg); margin:0 0 6px 0}
  p.lead{margin:0 0 12px 0; color:var(--muted)}

  /* Controls */
  .controls{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:14px;align-items:center}
  .controls .input{padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:transparent}
  .btn{background:linear-gradient(#ffd97a,#d4af37); border:1px solid rgba(0,0,0,0.08); color:var(--ink); padding:8px 10px; border-radius:8px; font-size:13px; cursor:pointer}
  .btn.ghost{background:transparent;border:1px dashed rgba(0,0,0,0.06); color:var(--header-bg)}

  /* Timeline layout */
  .timeline-wrap{display:grid;grid-template-columns:120px 1fr; gap:20px; align-items:start}
  @media (max-width:760px){ .timeline-wrap{grid-template-columns:1fr; gap:12px} }

  .year-col{display:flex;flex-direction:column;gap:20px;align-items:flex-end;padding-top:6px}
  .year-bubble{background:var(--header-bg); color:white;padding:10px 12px;border-radius:8px;font-weight:700;box-shadow:0 6px 16px rgba(0,0,0,0.12)}

  .events-col{position:relative;padding-top:6px}

  /* center the events list and create its own vertical timeline line */
  .events-list{counter-reset:event;list-style:none;margin:0 auto;padding:0 20px;position:relative;max-width:820px}
  .events-list::before{content:"";position:absolute;left:48px;top:0;bottom:0;width:4px;background:linear-gradient(180deg,var(--accent-cool), rgba(125,211,252,0.06));border-radius:2px;opacity:0.9}

  .event{position:relative;margin-bottom:18px;padding:14px 16px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,248,240,0.98));border:1px solid rgba(0,0,0,0.06);box-shadow:0 6px 18px rgba(0,0,0,0.06);padding-left:92px}
  .event::before{content:"";position:absolute;left:56px;top:20px;width:18px;height:18px;border-radius:50%;background:var(--accent-gold);border:3px solid var(--bg-paper)}
  .event h3{margin:0 0 6px 0;color:var(--header-bg);font-size:18px}
  .meta{font-size:13px;color:var(--muted);margin-bottom:8px}
  .desc{color:var(--ink);margin:0}

  /* year divider (appears before each year's group) */
  .year-divider{list-style:none;display:flex;justify-content:center;margin:18px 0}
  .year-bubble-inline{background:var(--header-bg);color:white;padding:10px 18px;border-radius:14px;font-weight:700;box-shadow:0 6px 16px rgba(0,0,0,0.12);border:3px solid var(--accent-gold)}

  /* mobile year bubble (inserted into each event) */
  .year-bubble-mobile{display:none;font-weight:700;padding:6px 10px;border-radius:8px;background:var(--header-bg);color:white;margin-bottom:8px;box-shadow:0 4px 10px rgba(0,0,0,0.08)}

  /* subtle transitions */
  .event, .year-bubble{transition:transform .18s ease,box-shadow .18s ease}
  .event:hover{transform:translateY(-4px);box-shadow:0 18px 34px rgba(0,0,0,0.12)}

  /* utilities */
  .right{margin-left:auto}

  /* Responsive adjustments */
  @media (max-width:760px){
    .timeline-wrap{grid-template-columns:1fr}
    .year-col{display:none}
    .events-list{max-width:100%;padding:0 12px}
    .events-list::before{left:20px}
    .event{padding-left:56px}
    .event::before{left:8px}
    .year-bubble-mobile{display:block}
    .event h3{font-size:16px}
  }

</style>
</head>
<body>

<header>
  <a href="../index.html">Home</a>
  <a href="personaggi.html">Personaggi</a>
  <a href="lore.html">Lore</a>
  <a href="mappa.html">Mappa</a>
  <a href="timeline.html">Timeline</a>
</header>

<main class="wrap">
  <section class="panel">
    <h1 class="title">Timeline — Campagna (DR)</h1>
    <p class="lead">Eventi ordinati cronologicamente (giorno, mese, anno — calendario Harptos / Dalereckoning).</p>

    <div class="controls" role="toolbar" aria-label="Controlli timeline">
      <button id="toggleOrder" class="btn">Ordine: Crescente</button>
      <button id="expandAll" class="btn ghost">Espandi/Comprimi descrizioni</button>
      <input id="search" class="input" placeholder="Cerca testo..." aria-label="Cerca eventi" />
      <input id="yearMin" type="number" class="input" placeholder="Anno min" aria-label="Anno minimo" />
      <input id="yearMax" type="number" class="input" placeholder="Anno massimo" />
      <button id="applyFilter" class="btn ghost">Applica filtro</button>
      <button id="clearFilter" class="btn ghost">Reset filtro</button>
    </div>

    <div class="timeline-wrap">
      <div class="year-col" id="yearCol" aria-hidden="true"></div>
      <div class="events-col" id="list" aria-live="polite"></div>
    </div>

  </section>
</main>

<script>
  // Harptos month order (Dalereckoning / Forgotten Realms)
  const MONTHS = ['Hammer','Alturiak','Ches','Tarsakh','Mirtul','Kythorn','Flamerule','Eleasis','Eleint','Marpenoth','Uktar','Nightal'];
  const monthIndex = m => { if(!m) return 1; const i = MONTHS.findIndex(x=> x.toLowerCase() === String(m).toLowerCase()); return i === -1 ? 1 : i+1 };

  // initial events (now with optional day/month fields)
  const defaultEvents = [
    {year:1216, month:'Hammer', day:12, title:"Nasce Im'lochar", desc:""},
    {year:1297, month:'Mirtul', day:13, title:"Nasce Valas Hune", desc:""},
    {year:1359, month:'Tarsakh', day:3, title:"Distruzione della casa Oblodra", desc:""},
    {year:1365, month:'Mirtul', day:18, title:"Arrivo dei superstiti Oblodra nel Nuovo Continente", desc:""},
    {year:1370, month:'Ches', day:5, title:"Fondazione di Isothar", desc:""},
    {year:1380, month:'Kythorn', day:10, title:"Primi Eilistrei si stabiliscono vicino a Isothar", desc:""},
    {year:1381, month:'Alturiak', day:5, title:"Nasce Balok", desc:""},
    {year:1396, month:'Flamerule', day:2, title:"Distruzione del villaggio degli Eilistrei", desc:""},
    {year:1509, month:'Marpenoth', day:20, title:"Micar è rinchiuso a Velkynvelve", desc:""},
    {year:1570, month:'Tarsakh', day:4, title:"Nasce Danvar", desc:""},
    {year:1566, month:'Ches', day:30, title:"Nasce Draxel", desc:""},
    {year:1589, month:'Hammer', day:13, title:"Attacco a Velkynvelve", desc:""},
    {year:1591, month:'Alturiak', day:20, title:"Micar arriva nel Nuovo Continente", desc:""},
    {year:1591, month:'Marpenoth', day:12, title:"Battaglia Fantasma di Vingaldrum", desc:""},
    {year:1591, month:'Marpenoth', day:28, title:"Esecuzione di Tal'Noriel a Vingaldrum", desc:"Istituzione della Festa della Corona, annuale."}
  ];

  const STORAGE_KEY = 'campaignTimeline_v1';
  let events = loadEvents();
  let ascending = true;
  let filter = { q:'', min:null, max:null };

  // DOM refs
  const listEl = document.getElementById('list');
  const yearCol = document.getElementById('yearCol');
  const toggleBtn = document.getElementById('toggleOrder');
  const expandBtn = document.getElementById('expandAll');
  const searchEl = document.getElementById('search');
  const yearMinEl = document.getElementById('yearMin');
  const yearMaxEl = document.getElementById('yearMax');
  const applyFilterBtn = document.getElementById('applyFilter');
  const clearFilterBtn = document.getElementById('clearFilter');

  // load from storage
  function loadEvents(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw){ const parsed = JSON.parse(raw); if(Array.isArray(parsed)) return parsed; }
    }catch(e){ console.warn('Storage load failed',e) }
    return defaultEvents.slice();
  }
  function persist(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(events)); }

  function formatDate(ev){
    if(!ev) return '';
    const d = ev.day ? ev.day + ' ' : '';
    const m = ev.month ? ev.month + ' ' : '';
    return (d + m + ev.year + ' DR').trim();
  }

  function render(){
    // apply filter
    const filtered = events.filter(ev=>{
      if(filter.q){ const s=(ev.title+' '+(ev.desc||'')).toLowerCase(); if(!s.includes(filter.q.toLowerCase())) return false }
      if(filter.min !== null && ev.year < filter.min) return false;
      if(filter.max !== null && ev.year > filter.max) return false;
      return true;
    });

    // sort chronologically by year, month (Harptos), day
    const sorted = filtered.slice().sort((a,b)=>{
      const ay = a.year||0, by = b.year||0;
      if(ay !== by) return ascending? ay - by : by - ay;
      const am = monthIndex(a.month), bm = monthIndex(b.month);
      if(am !== bm) return ascending? am - bm : bm - am;
      const ad = a.day||1, bd = b.day||1;
      if(ad !== bd) return ascending? ad - bd : bd - ad;
      return (a.title||'').localeCompare(b.title||'');
    });

    // build events column as ordered list with year dividers inserted before each year's group
    listEl.innerHTML = '';
    const ol = document.createElement('ol'); ol.className='events-list';
    let lastYear = null;
    for(let i=0;i<sorted.length;i++){
      const ev = sorted[i];

      // if this is the first event of a new year, insert a year bubble BEFORE it
      if(lastYear === null || ev.year !== lastYear){
        const divider = document.createElement('li'); divider.className = 'year-divider';
        const bubble = document.createElement('div'); bubble.className = 'year-bubble-inline'; bubble.textContent = ev.year + ' DR';
        divider.appendChild(bubble);
        ol.appendChild(divider);
      }

      const li = document.createElement('li'); li.className='event'; li.id = anchorId(ev);

      const yb = document.createElement('div'); yb.className = 'year-bubble-mobile'; yb.textContent = formatDate(ev);
      const h = document.createElement('h3'); h.textContent = ev.title;
      const meta = document.createElement('div'); meta.className='meta'; meta.textContent = formatDate(ev) + ' — ' + (ev.tag || 'Evento cronologico');
      const p = document.createElement('p'); p.className='desc'; p.textContent = ev.desc || '';

      li.appendChild(yb);
      li.appendChild(h);
      li.appendChild(meta);
      li.appendChild(p);
      ol.appendChild(li);

      lastYear = ev.year;
    }
    listEl.appendChild(ol);
  }

  // helper anchor id
  function anchorId(ev){
    return 'ev-'+String(ev.year)+'-'+String(ev.month||'')+'-'+String(ev.day||'')+'-'+slug(ev.title);
  }
  function slug(s){ return String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }

  // controls
  toggleBtn.addEventListener('click', ()=>{ ascending = !ascending; toggleBtn.textContent = 'Ordine: ' + (ascending? 'Crescente' : 'Decrescente'); render(); });
  expandBtn.addEventListener('click', ()=>{ document.querySelectorAll('.desc').forEach(p=>{ p.style.display = p.style.display === 'none' ? 'block' : 'none'; }); });

  applyFilterBtn.addEventListener('click', ()=>{ filter.q = searchEl.value.trim(); filter.min = yearMinEl.value? parseInt(yearMinEl.value,10):null; filter.max = yearMaxEl.value? parseInt(yearMaxEl.value,10):null; render(); });
  clearFilterBtn.addEventListener('click', ()=>{ searchEl.value=''; yearMinEl.value=''; yearMaxEl.value=''; filter = {q:'',min:null,max:null}; render(); });

  // initial render
  render();

  // accessibility: keyboard shortcuts
  window.addEventListener('keydown', (e)=>{
    if(e.key === 'f' && (e.ctrlKey||e.metaKey)){ e.preventDefault(); searchEl.focus(); }
  });

</script>
</body>
</html>
